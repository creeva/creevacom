{"id":2380,"date":"2008-01-18T15:22:45","date_gmt":"2008-01-18T20:22:45","guid":{"rendered":"http:\/\/localhost\/wordpress\/2008\/01\/18\/cheap-and-dirty-windows-log-file-archiving\/"},"modified":"2023-02-06T16:27:41","modified_gmt":"2023-02-06T16:27:41","slug":"cheap-and-dirty-windows-log-file-archiving","status":"publish","type":"post","link":"http:\/\/localhost\/wordpress\/index.php\/2008\/01\/18\/cheap-and-dirty-windows-log-file-archiving\/","title":{"rendered":"Cheap and Dirty Windows Log File Archiving"},"content":{"rendered":"<p><img decoding=\"async\" class=\"aligncenter size-large wp-image-97594\" src=\"http:\/\/localhost\/wordpress\/wp-content\/uploads\/2022\/06\/switch-1-1024x768.jpg\" alt=\"\" width=\"1024\" height=\"768\" srcset=\"http:\/\/localhost\/wordpress\/wp-content\/uploads\/2022\/06\/switch-1-1024x768.jpg 1024w, http:\/\/localhost\/wordpress\/wp-content\/uploads\/2022\/06\/switch-1-300x225.jpg 300w, http:\/\/localhost\/wordpress\/wp-content\/uploads\/2022\/06\/switch-1-768x576.jpg 768w, http:\/\/localhost\/wordpress\/wp-content\/uploads\/2022\/06\/switch-1-1536x1152.jpg 1536w, http:\/\/localhost\/wordpress\/wp-content\/uploads\/2022\/06\/switch-1.jpg 1600w\" sizes=\"(max-width: 1024px) 100vw, 1024px\" \/><\/p>\n<p>So your company has a requirement to maintain log files for a year?<\/p>\n<p>You don&#8217;t know how to go about it and you need to implement it now?<\/p>\n<p>I have a solution for you and best of all it&#8217;s free. This solution however is not supported by me, there will be no bug fixes by me, and any damage you cause to your own servers is your own fault. That is my one-sentence disclaimer to tell you that you truly are on your own.<\/p>\n<p>For this solution or temporary fix (depending on your organization) you are going to need the following helper programs:<\/p>\n<p><a href=\"http:\/\/www.info-zip.org\/\" target=\"_blank\" rel=\"noopener\">Info-zip<\/a> &#8211; we&#8217;ll use this to compress down files and save space specifically we need the zip.exe file<\/p>\n<p><a href=\"http:\/\/www.pc-tools.net\/win32\/md5sums\/\" target=\"_blank\" rel=\"noopener\">MD5SUMS<\/a> &#8211; this allows us to generate MD5 checksums to verify if any file tampering has taken place after the fact. Specifically, we need the md5sums.exe file.<\/p>\n<p><a href=\"http:\/\/download.microsoft.com\/download\/win2000platform\/webpacks\/1.00.0.1\/nt5\/en-us\/dumpel.exe\" target=\"_blank\" rel=\"noopener\">Dump Event Log (Dumpel.exe)<\/a> &#8211; this is a tool offered by Microsoft to dump your event logs into a text file. Though this link is part of the Windows 2000 Resource Kit I have tested and it does work with the Windows XP and Windows Server 2003 log files.<\/p>\n<p>We take these 3 programs and wrap them to work together via a batch file. All 3 of these programs MUST be in the same directory as the batch file for it to work as designed. Here is the batch file:<\/p>\n<blockquote><p>@echo off<br \/>\nREM Sets date variables for file name<br \/>\nfor \/F &#8220;tokens=1,2&#8221; %%d in (&#8216;date \/T&#8217;) do set day=%%d &amp; set date=%%e<br \/>\nset yyyy=%DATE:~6,4%<br \/>\nset dd=%DATE:~3,2%<br \/>\nset mm=%DATE:~0,2%<br \/>\nset startDate=%yyyy%-%mm%-%dd%<br \/>\nREM Adds Computer to prefix the date<br \/>\nset outputname=%computername%-%startdate%<br \/>\nREM Cleans out previous zip files from a bad run<br \/>\ndel %outputname%.zip<br \/>\nREM Dumps each of the log files going back for 2 days<br \/>\nREM allowing for overlaps we may miss due to time changes<br \/>\ndumpel -f %outputname%.sec -l security -d 2<br \/>\ndumpel -f %outputname%.app -l application -d 2<br \/>\ndumpel -f %outputname%.sys -l system -d 2<br \/>\nREM creates an MD5 hash for verification checking<br \/>\nmd5sums %outputname%.sec &gt;%outputname%.md5<br \/>\nmd5sums %outputname%.app &gt;&gt;%outputname%.md5<br \/>\nmd5sums %outputname%.sys &gt;&gt;%outputname%.md5<br \/>\nREM Compresses the 4 files<br \/>\nzip %outputname%.zip %outputname%.*<br \/>\nREM Cleans up the unneeded files to save<br \/>\ndel %outputname%.sec<br \/>\ndel %outputname%.app<br \/>\ndel %outputname%.sys<br \/>\ndel %outputname%.md5<\/p><\/blockquote>\n<p>I&#8217;ve included my comments in the batch file &#8211; but let&#8217;s go through it a section at a time so you can fully understand it.<\/p>\n<blockquote><p>@echo off<\/p><\/blockquote>\n<p>If you don&#8217;t know @echo off suppresses everything from your screen in a batch, I wouldn&#8217;t suggest modifying my script since this is batch file programming 101.<\/p>\n<blockquote><p>for \/F &#8220;tokens=1,2&#8221; %%d in (&#8216;date \/T&#8217;) do set day=%%d &amp; set date=%%e<br \/>\nset yyyy=%DATE:~6,4%<br \/>\nset dd=%DATE:~3,2%<br \/>\nset mm=%DATE:~0,2%<br \/>\nset startDate=%yyyy%-%mm%-%dd%<br \/>\nREM Adds Computer to prefix the date<br \/>\nset outputname=%computername%-%startdate%<\/p><\/blockquote>\n<p>This section adds the prefix to the files we are going to be using on all of your files &#8211; these allow us to work with files that include the computer&#8217;s name you are running this on and the date on which it was run.<\/p>\n<blockquote><p>del %outputname%.zip<\/p><\/blockquote>\n<p>This verification actually cleans up the zip file if this script has already been run during the current day. Mine is modified to delete the zip file completely since at the end of my script I move my files to a remote location and don&#8217;t need archived logs filling up my hard drive quickly.<\/p>\n<blockquote><p>dumpel -f %outputname%.sec -l security -d 2<br \/>\ndumpel -f %outputname%.app -l application -d 2<br \/>\ndumpel -f %outputname%.sys -l system -d 2<\/p><\/blockquote>\n<p>This area does the physical dumping of the log file. Dumpel is the command. The -f switch allows us to specify a file name. If you notice I used the %outputname% as the first part of the file with the file type of which log file it is as the suffix. The -l switch lets us specify which logfile we are dumping from the event log (security, application, or system). the -d switch allows us to specify how many days we wish to save. I chose 2 days to allow some overlap on the log files which is good for security reasons since we shouldn&#8217;t miss any events if you change the time of the day the script is run. It also gives us two more logfiles to verify the authenticity of the log data we are looking at.<\/p>\n<p>When this section is done running you should have three files. If your computer&#8217;s name was BOB-SERVER and the date you ran this was on January 3, 2007, the file names would read like this; BOB-SERVER-2007-01-03.sec for your security log, BOB-SERVER-2007-01-03.app for your application log, and BOB-SERVER-2007-01-03.sys for your system log.<\/p>\n<blockquote><p>md5sums %outputname%.sec &gt;%outputname%.md5<br \/>\nmd5sums %outputname%.app &gt;&gt;%outputname%.md5<br \/>\nmd5sums %outputname%.sys &gt;&gt;%outputname%.md5<\/p><\/blockquote>\n<p>This section generates an <a href=\"http:\/\/en.wikipedia.org\/wiki\/Md5_Hash\" target=\"_blank\" rel=\"noopener\">MD5 Hash<\/a> of the logfile data allows you to see if the data was tampered with when it was originally generated. It is next to impossible to edit a file and maintain the same hash data. This allows you some security that your log files are authentic. For those wondering &#8220;well can&#8217;t I just rerun the md5 program and generate a new hash and save that after modification?&#8221; &#8211; I have your answer. I didn&#8217;t include how to store these files after they are generated and we will touch upon that question under &#8220;What do you do now?&#8221; at the bottom. The command outputs your three BOB-SERVER-2007-01-03 files and outputs it to a single BOB-SERVER-2007-01-03.md5 file that includes a section with each of the above files. I decided personally that I didn&#8217;t need an md5 file for each of them &#8211; feel free to modify this if your needs differ.<\/p>\n<blockquote><p>zip %outputname%.zip %outputname%.*<\/p><\/blockquote>\n<p>This compresses the dumped events logs down to a manageable size. I managed to get a 60 MB log file that I generated during varying testing phases down to just over 6 MB. I also managed to get 480 KB of log files down to 14kb. At this point, you should have a BOB-SERVER-2007-01-03.zip file which includes your three event logs and your md5 file.<\/p>\n<blockquote><p>del %outputname%.sec<br \/>\ndel %outputname%.app<br \/>\ndel %outputname%.sys<br \/>\ndel %outputname%.md5<\/p><\/blockquote>\n<p>This section cleans up the files outside of the zip. I manage to get these files down 90% in size I don&#8217;t need these to eat up extra space.<\/p>\n<p>What do you do now?<\/p>\n<p>From here I would add a line at the end to move the logs to another server where you can store them for the length your organization deems necessary. To help combat the MD5 re-engineering I mentioned above I would copy the compressed archived to two locations on your network. This will help make having an MD5 meaningful. Another option is adding a script that e-mails you the MD5 hash so you have it saved for reference. Having the MD5 and collecting 2 days of information from the logs would mean an attacker may have to edit 2-4 archives and regenerate MD5s for them &#8211; double that if you store a second set of archives in another location.<\/p>\n<p>While this may fulfill your needs for log file capturing and an easy way to store them, it does not address the fact of easy log file auditing and tracking down events. There are all-in-one solutions out there for you to use and I don&#8217;t say in any terms this is a solution to those. You need to address your own needs and decide what works for you. This is to give you some time until you decide what you are going to do.<\/p>\n","protected":false},"excerpt":{"rendered":"<p>So your company has a requirement to maintain log files for a year? You don&#8217;t know how to go about it and you need to implement it now? I have a solution for you and &hellip;<\/p>\n","protected":false},"author":1,"featured_media":97594,"comment_status":"closed","ping_status":"closed","sticky":false,"template":"","format":"standard","meta":[],"categories":[3],"tags":[],"jetpack_featured_media_url":"http:\/\/localhost\/wordpress\/wp-content\/uploads\/2022\/06\/switch-1.jpg","_links":{"self":[{"href":"http:\/\/localhost\/wordpress\/index.php\/wp-json\/wp\/v2\/posts\/2380"}],"collection":[{"href":"http:\/\/localhost\/wordpress\/index.php\/wp-json\/wp\/v2\/posts"}],"about":[{"href":"http:\/\/localhost\/wordpress\/index.php\/wp-json\/wp\/v2\/types\/post"}],"author":[{"embeddable":true,"href":"http:\/\/localhost\/wordpress\/index.php\/wp-json\/wp\/v2\/users\/1"}],"replies":[{"embeddable":true,"href":"http:\/\/localhost\/wordpress\/index.php\/wp-json\/wp\/v2\/comments?post=2380"}],"version-history":[{"count":2,"href":"http:\/\/localhost\/wordpress\/index.php\/wp-json\/wp\/v2\/posts\/2380\/revisions"}],"predecessor-version":[{"id":101235,"href":"http:\/\/localhost\/wordpress\/index.php\/wp-json\/wp\/v2\/posts\/2380\/revisions\/101235"}],"wp:featuredmedia":[{"embeddable":true,"href":"http:\/\/localhost\/wordpress\/index.php\/wp-json\/wp\/v2\/media\/97594"}],"wp:attachment":[{"href":"http:\/\/localhost\/wordpress\/index.php\/wp-json\/wp\/v2\/media?parent=2380"}],"wp:term":[{"taxonomy":"category","embeddable":true,"href":"http:\/\/localhost\/wordpress\/index.php\/wp-json\/wp\/v2\/categories?post=2380"},{"taxonomy":"post_tag","embeddable":true,"href":"http:\/\/localhost\/wordpress\/index.php\/wp-json\/wp\/v2\/tags?post=2380"}],"curies":[{"name":"wp","href":"https:\/\/api.w.org\/{rel}","templated":true}]}}